-- Columns for waiter mode
alter table public.restaurants
  add column if not exists waiter_mode_enabled boolean default false not null;
alter table public.restaurants
  add column if not exists allow_waiter_payments boolean default false not null;

-- Allow owners/staff to create tables only for their restaurant
drop policy if exists "tables-insert-staff" on public.tables;
create policy "tables-insert-staff" on public.tables
for insert
to authenticated
with check (
  exists (
    select 1 from public.restaurants r
    where r.id = restaurant_id and r.owner_id = auth.uid()
  )
  or exists (
    select 1 from public.restaurant_staff rs
    where rs.restaurant_id = restaurant_id and rs.user_id = auth.uid()
  )
);

-- Anon inserts: allow customer QR flow to create orders tied to an open table session
drop policy if exists "orders-anon-insert" on public.orders;
create policy "orders-anon-insert" on public.orders
for insert
to anon
with check (
  table_session_id is not null
  and exists (
    select 1
    from public.table_sessions ts
    join public.tables t on t.id = ts.table_id
    where ts.id = table_session_id
      and ts.status = 'OPEN'
  )
);

drop policy if exists "order-items-anon-insert" on public.order_items;
create policy "order-items-anon-insert" on public.order_items
for insert
to anon
with check (
  order_id is not null
  and exists (
    select 1
    from public.orders o
    join public.table_sessions ts on ts.id = o.table_session_id
    where o.id = order_id
      and ts.status = 'OPEN'
  )
);

-- Staff/owners can manage all orders for their restaurant (including anon ones)
drop policy if exists "orders-staff-rw" on public.orders;
create policy "orders-staff-rw" on public.orders
for select using (
  exists (
    select 1 from public.restaurants r
    where r.id = restaurant_id
      and (r.owner_id = auth.uid() or exists (
        select 1 from public.restaurant_staff rs
        where rs.restaurant_id = restaurant_id and rs.user_id = auth.uid()
      ))
  )
);
create policy "orders-staff-update" on public.orders
for update
to authenticated
using (
  exists (
    select 1 from public.restaurants r
    where r.id = restaurant_id
      and (r.owner_id = auth.uid() or exists (
        select 1 from public.restaurant_staff rs
        where rs.restaurant_id = restaurant_id and rs.user_id = auth.uid()
      ))
  )
)
with check (true);

-- Order items read/update for staff
do $$
begin
  if not exists (
    select 1 from pg_policies where schemaname = 'public' and tablename = 'order_items' and policyname = 'order-items-staff-rw'
  ) then
    create policy "order-items-staff-rw" on public.order_items
    for select using (
      exists (
        select 1 from public.orders o
        join public.restaurants r on r.id = o.restaurant_id
        where o.id = order_id
          and (r.owner_id = auth.uid() or exists (
            select 1 from public.restaurant_staff rs where rs.restaurant_id = o.restaurant_id and rs.user_id = auth.uid()
          ))
      )
    );
  end if;
end $$;
